<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Farming Marketplace - Smart Farming Assistant</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        :root {
            --primary-dark: #2C3E50;
            --primary-base: #34495E;
            --primary-mid: #5D6D7E;
            --primary-light: #85929E;
            --accent-blue: #2874A6;
            --accent-purple: #4A235A;
            --professional-gradient: linear-gradient(135deg, #2874A6 0%, #34495E 48%, #2C3E50 100%);
            --professional-gradient-dark: linear-gradient(135deg, #1B2631 0%, #273746 100%);
            --success-color: #2E86C1;
            --warning-color: #D68910;
            --danger-color: #C0392B;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--professional-gradient);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 3px 12px rgba(0,0,0,0.4);
            font-weight: bold;
        }

        .ai-status {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 20px;
            background: rgba(46, 134, 193, 0.3);
            border-radius: 25px;
            font-size: 0.9rem;
            color: #2E86C1;
            border: 1px solid rgba(46, 134, 193, 0.5);
        }

        .ai-status.loading {
            background: rgba(214, 137, 16, 0.3);
            color: #D68910;
            border-color: rgba(214, 137, 16, 0.5);
        }

        .ai-status.error {
            background: rgba(192, 57, 43, 0.3);
            color: #C0392B;
            border-color: rgba(192, 57, 43, 0.5);
        }

        .marketplace-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(44, 62, 80, 0.15);
            padding: 40px;
            border: 2px solid rgba(52, 73, 94, 0.2);
        }

        .controls-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .filters {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 24px;
            background: white;
            border: 2px solid var(--primary-mid);
            border-radius: 25px;
            color: var(--primary-dark);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(40, 116, 166, 0.15);
        }

        .filter-btn:hover, .filter-btn.active {
            background: var(--primary-mid);
            color: white;
            border-color: var(--primary-dark);
            transform: translateY(-2px) scale(1.05);
        }

        .top-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .refresh-prices-btn {
            background: var(--professional-gradient);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 3px 12px rgba(40, 116, 166, 0.3);
        }

        .refresh-prices-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(40, 116, 166, 0.4);
        }

        .refresh-prices-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Cart Button */
        .cart-btn {
            background: linear-gradient(135deg, #4A235A 0%, #2C3E50 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }

        .cart-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(74, 35, 90, 0.4);
        }

        .cart-count {
            background: #C0392B;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
            position: absolute;
            top: -5px;
            right: -5px;
        }

        .product-count {
            color: var(--primary-dark);
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 28px;
        }

        .product-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 7px 30px rgba(44, 62, 80, 0.12);
            border: 2.5px solid var(--primary-light);
            transition: all 0.23s cubic-bezier(.29,.42,.62,.84);
            position: relative;
        }

        .product-card:hover {
            transform: translateY(-7px) scale(1.02);
            border-color: var(--primary-dark);
            box-shadow: 0 17px 42px rgba(44, 62, 80, 0.20);
        }

        .product-card.loading {
            opacity: 0.7;
        }

        .product-image {
            height: 200px;
            background: var(--professional-gradient-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.2rem;
            color: #D5DBDB;
            text-shadow: 0 3px 8px rgba(44, 62, 80, 0.3);
            border-top-left-radius: 14px;
            border-top-right-radius: 14px;
        }

        .product-content {
            padding: 20px;
        }

        .product-title {
            font-size: 1.27rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 11px;
        }

        .product-description {
            color: #566573;
            line-height: 1.55;
            margin-bottom: 16px;
            font-size: 0.9rem;
        }

        .product-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .rating {
            color: #D68910;
        }

        .stock {
            color: var(--success-color);
            font-weight: 600;
        }

        .stock.low {
            color: var(--warning-color);
        }

        .stock.out {
            color: var(--danger-color);
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .quantity-btn {
            background: #D5DBDB;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--primary-dark);
            transition: all 0.3s ease;
        }

        .quantity-btn:hover {
            background: var(--primary-mid);
            color: white;
        }

        .quantity-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .quantity-display {
            background: #F8F9FA;
            border: 2px solid #D5DBDB;
            border-radius: 8px;
            padding: 5px 15px;
            font-weight: 600;
            color: var(--primary-dark);
            min-width: 50px;
            text-align: center;
        }

        .product-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 19px;
            padding-top: 13px;
            border-top: 1.5px solid #EBF5FB;
            flex-wrap: wrap;
            gap: 10px;
        }

        .price-container {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .price {
            font-size: 1.38rem;
            font-weight: 700;
            color: var(--primary-dark);
            letter-spacing: 0.1px;
        }

        .price.loading {
            background: linear-gradient(90deg, #e0e0e0 25%, #f0f0f0 50%, #e0e0e0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
            min-width: 80px;
            height: 20px;
        }

        .price-change {
            font-size: 0.8rem;
            font-weight: 600;
        }

        .price-up {
            color: #C0392B;
        }

        .price-down {
            color: #2E86C1;
        }

        .price-updated {
            font-size: 0.7rem;
            color: #7B7D7D;
            font-style: italic;
        }

        .buy-btn {
            background: var(--professional-gradient);
            color: white;
            border: none;
            padding: 10px 22px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(40, 116, 166, 0.3);
        }

        .buy-btn:hover {
            background: var(--professional-gradient-dark);
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 7px 29px rgba(44, 62, 80, 0.4);
        }

        .buy-btn.in-cart {
            background: linear-gradient(135deg, #C0392B 0%, #922B21 100%);
        }

        .buy-btn.in-cart:hover {
            background: linear-gradient(135deg, #922B21 0%, #7B241C 100%);
        }

        .featured-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--accent-blue);
            color: white;
            padding: 5px 13px;
            border-radius: 14px;
            font-size: 0.83rem;
            font-weight: 800;
            letter-spacing: 1px;
            box-shadow: 0 4px 12px rgba(40, 116, 166, 0.3);
            border: 1px solid #2E86C1;
        }

        .ai-powered-badge {
            position: absolute;
            top: 15px;
            left: 15px;
            background: linear-gradient(135deg, #4A235A 0%, #2C3E50 100%);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            border-radius: 16px;
            z-index: 10;
        }

        .loading-overlay.show {
            display: flex;
        }

        /* Cart Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: var(--professional-gradient);
            color: white;
            padding: 25px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .close {
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close:hover {
            transform: scale(1.2);
            opacity: 0.8;
        }

        .modal-body {
            padding: 25px;
        }

        .cart-item {
            display: flex;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #EBF5FB;
            gap: 20px;
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .cart-item-image {
            width: 80px;
            height: 80px;
            background: var(--professional-gradient-dark);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            flex-shrink: 0;
        }

        .cart-item-details {
            flex: 1;
        }

        .cart-item-name {
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 5px;
        }

        .cart-item-price {
            color: #7B7D7D;
            font-size: 0.9rem;
        }

        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .cart-total {
            background: #F8F9FA;
            padding: 25px;
            border-top: 2px solid #D5DBDB;
            border-radius: 0 0 20px 20px;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .total-row.grand-total {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary-dark);
            border-top: 2px solid var(--primary-mid);
            padding-top: 15px;
            margin-top: 15px;
        }

        .checkout-btn {
            background: var(--professional-gradient);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .checkout-btn:hover {
            background: var(--professional-gradient-dark);
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(40, 116, 166, 0.4);
        }

        .checkout-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .empty-cart {
            text-align: center;
            padding: 60px 20px;
            color: #7B7D7D;
        }

        .empty-cart i {
            font-size: 4rem;
            color: #D5DBDB;
            margin-bottom: 20px;
        }

        /* Success Message */
        .success-modal {
            background: linear-gradient(135deg, #2E86C1 0%, #2874A6 100%);
            color: white;
            text-align: center;
            padding: 40px;
            border-radius: 20px;
        }

        .success-modal i {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .success-modal h2 {
            margin-bottom: 15px;
            font-size: 2rem;
        }

        .razorpay-payment-button {
            display: none !important;
        }

        .payment-methods {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .payment-icon {
            width: 40px;
            height: 25px;
            background: #f8f9fa;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
            border: 1px solid #ddd;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .products-grid {
                grid-template-columns: 1fr;
            }
            
            .marketplace-container {
                padding: 23px;
                margin: 0 7px;
            }
            
            .controls-row {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filters {
                justify-content: center;
            }

            .modal-content {
                width: 95%;
                margin: 2% auto;
            }

            .cart-item {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }

            .product-footer {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-store"></i> Professional Farming Marketplace</h1>
            <p>Advanced agricultural solutions powered by AI technology</p>
            <div class="ai-status" id="aiStatus">
                <i class="fas fa-circle pulse"></i> Connecting to AI Analytics...
            </div>
        </div>

        <div class="marketplace-container">
            <div class="controls-row">
                <div class="filters">
                    <button class="filter-btn active" data-category="all">All Products</button>
                    <button class="filter-btn" data-category="fertilizer">Fertilizers</button>
                    <button class="filter-btn" data-category="seeds">Seeds</button>
                    <button class="filter-btn" data-category="equipment">Equipment</button>
                    <button class="filter-btn" data-category="organic">Organic</button>
                </div>
                <div class="top-controls">
                    <button class="cart-btn" id="cartBtn" onclick="openCart()">
                        <i class="fas fa-shopping-cart"></i>
                        Cart
                        <div class="cart-count" id="cartCount">0</div>
                    </button>
                    <button class="refresh-prices-btn" id="refreshPrices">
                        <i class="fas fa-sync-alt"></i>
                        Update Prices with AI
                    </button>
                </div>
            </div>

            <div class="product-count" id="productCount">
                Loading products...
            </div>

            <div class="products-grid" id="productsGrid">
                <!-- Products will be dynamically loaded here -->
            </div>
        </div>
    </div>

    <!-- Cart Modal -->
    <div id="cartModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-shopping-cart"></i> Your Cart</h2>
                <button class="close" onclick="closeCart()">&times;</button>
            </div>
            <div class="modal-body" id="cartItems">
                <!-- Cart items will be loaded here -->
            </div>
            <div class="cart-total" id="cartTotal">
                <!-- Cart total will be displayed here -->
            </div>
        </div>
    </div>

    <!-- Order Success Modal -->
    <div id="successModal" class="modal">
        <div class="modal-content">
            <div class="success-modal">
                <i class="fas fa-check-circle"></i>
                <h2>Payment Successful!</h2>
                <p>Thank you for your purchase. Your farming supplies will be delivered within 3-5 business days.</p>
                <p><strong>Order ID: </strong><span id="orderId"></span></p>
                <p><strong>Payment ID: </strong><span id="paymentId"></span></p>
                <button class="checkout-btn" onclick="closeSuccess(); printOrderDetails();" style="margin-top: 25px; max-width: 250px;">
                    <i class="fas fa-print"></i> Print Receipt & Continue
                </button>
            </div>
        </div>
    </div>

    <script>
        // Razorpay Payment Integration
        function razorpayPayment(totalAmount, orderId) {
            console.log('üöÄ Starting Razorpay payment process...');
            console.log('üí∞ Payment Amount:', totalAmount, 'INR');
            console.log('üìã Order ID:', orderId);
            
            const options = {
                key: 'rzp_test_YOUR_RAZORPAY_KEY_ID', // Replace with your actual Razorpay key
                amount: totalAmount * 100, // Amount in paise (multiply by 100)
                currency: 'INR',
                name: 'Smart Farming Assistant',
                description: 'Premium Agricultural Products',
                image: 'https://cdn-icons-png.flaticon.com/512/628/628283.png', // Optional logo
                order_id: '', // This should be generated from server in production
                handler: function (response) {
                    console.log('‚úÖ Payment successful!');
                    console.log('üí≥ Payment Response:', response);
                    console.log('üîë Payment ID:', response.razorpay_payment_id);
                    console.log('üìë Order ID:', response.razorpay_order_id);
                    console.log('üîê Signature:', response.razorpay_signature);
                    
                    // Store payment details
                    sessionStorage.setItem('paymentId', response.razorpay_payment_id);
                    sessionStorage.setItem('orderId', orderId);
                    
                    // Show success modal
                    showPaymentSuccess(orderId, response.razorpay_payment_id);
                    
                    // Print order details to console
                    console.log('üìÑ Printing order details...');
                    printOrderDetails();
                },
                prefill: {
                    name: 'Farmer',
                    email: 'farmer@smartagriculture.com',
                    contact: '+91XXXXXXXXXX'
                },
                notes: {
                    address: 'Smart Farming Assistant - Agricultural Marketplace'
                },
                theme: {
                    color: '#2874A6'
                },
                modal: {
                    ondismiss: function() {
                        console.log('‚ùå Payment cancelled by user');
                        alert('Payment was cancelled. Please try again.');
                    }
                }
            };
            
            const rzp1 = new Razorpay(options);
            
            rzp1.on('payment.failed', function (response) {
                console.log('‚ùå Payment failed!');
                console.log('üí• Error:', response.error);
                alert('Payment failed: ' + response.error.description);
            });
            
            rzp1.open();
        }

        function showPaymentSuccess(orderId, paymentId) {
            document.getElementById('successModal').style.display = 'block';
            document.getElementById('orderId').textContent = orderId;
            document.getElementById('paymentId').textContent = paymentId;
        }

        function printOrderDetails() {
            const orderId = sessionStorage.getItem('orderId') || document.getElementById('orderId').textContent;
            const paymentId = sessionStorage.getItem('paymentId') || document.getElementById('paymentId').textContent;
            const cartItems = marketplace.cart;
            const timestamp = new Date().toLocaleString();
            
            console.log('üñ®Ô∏è ============ ORDER RECEIPT ============');
            console.log('üè™ Smart Farming Assistant - Professional Marketplace');
            console.log('üìÖ Date & Time:', timestamp);
            console.log('üìã Order ID:', orderId);
            console.log('üí≥ Payment ID:', paymentId);
            console.log('‚îÄ'.repeat(45));
            console.log('üì¶ ORDERED ITEMS:');
            
            let totalAmount = 0;
            cartItems.forEach((item, index) => {
                const itemTotal = item.price * item.quantity;
                totalAmount += itemTotal;
                console.log(`${index + 1}. ${item.name}`);
                console.log(`   Price: ‚Çπ${item.price} x ${item.quantity} = ‚Çπ${itemTotal.toLocaleString()}`);
                console.log(`   Category: ${item.category.charAt(0).toUpperCase() + item.category.slice(1)}`);
                console.log('');
            });
            
            const shipping = totalAmount > 2000 ? 0 : 100;
            const tax = Math.round(totalAmount * 0.05);
            const grandTotal = totalAmount + shipping + tax;
            
            console.log('‚îÄ'.repeat(45));
            console.log('üí∞ PAYMENT SUMMARY:');
            console.log('   Subtotal: ‚Çπ' + totalAmount.toLocaleString());
            console.log('   Shipping: ‚Çπ' + (shipping === 0 ? '0 (Free)' : shipping));
            console.log('   Tax (5%): ‚Çπ' + tax.toLocaleString());
            console.log('   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');
            console.log('   TOTAL PAID: ‚Çπ' + grandTotal.toLocaleString());
            console.log('‚îÄ'.repeat(45));
            console.log('üìû Support: +91-XXXX-XXXX-XX');
            console.log('üìß Email: support@smartfarming.com');
            console.log('üåê Website: www.smartfarmingassistant.com');
            console.log('============================================');
            
            // Also trigger browser print if available
            if (window.print) {
                setTimeout(() => {
                    // Create a printable version
                    const printContent = `
                        <div style="font-family: monospace; padding: 20px; max-width: 400px;">
                            <h2>üè™ Smart Farming Assistant</h2>
                            <p><strong>Professional Agricultural Marketplace</strong></p>
                            <hr>
                            <p><strong>Date:</strong> ${timestamp}</p>
                            <p><strong>Order ID:</strong> ${orderId}</p>
                            <p><strong>Payment ID:</strong> ${paymentId}</p>
                            <hr>
                            <h3>üì¶ Ordered Items:</h3>
                            ${cartItems.map((item, index) => `
                                <div style="margin: 10px 0;">
                                    <strong>${index + 1}. ${item.name}</strong><br>
                                    ‚Çπ${item.price} x ${item.quantity} = ‚Çπ${(item.price * item.quantity).toLocaleString()}
                                </div>
                            `).join('')}
                            <hr>
                            <p><strong>Subtotal:</strong> ‚Çπ${totalAmount.toLocaleString()}</p>
                            <p><strong>Shipping:</strong> ‚Çπ${shipping === 0 ? '0 (Free)' : shipping}</p>
                            <p><strong>Tax (5%):</strong> ‚Çπ${tax.toLocaleString()}</p>
                            <h3><strong>Total Paid: ‚Çπ${grandTotal.toLocaleString()}</strong></h3>
                            <hr>
                            <p>üìû Support: +91-XXXX-XXXX-XX</p>
                            <p>Thank you for choosing Smart Farming Assistant!</p>
                        </div>
                    `;
                    
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(`
                        <html>
                            <head>
                                <title>Order Receipt - ${orderId}</title>
                                <style>
                                    body { font-family: 'Courier New', monospace; }
                                    @media print {
                                        body { margin: 0; }
                                    }
                                </style>
                            </head>
                            <body onload="window.print(); window.close();">
                                ${printContent}
                            </body>
                        </html>
                    `);
                    printWindow.document.close();
                }, 500);
            }
        }

        class AIMarketplace {
            constructor() {
                this.geminiApiKey = 'AIzaSyDh_q12etYVVvBmqqqZzfO5aGiWZ2Z-lB4';
                this.products = [];
                this.cart = [];
                this.currentFilter = 'all';
                this.isUpdating = false;
                
                this.init();
            }

            init() {
                console.log('üöÄ Initializing AI Marketplace with Razorpay integration...');
                this.checkAIStatus();
                this.loadProducts();
                this.bindEvents();
                this.loadCart();
                
                // Auto-refresh prices every 10 minutes
                setInterval(() => this.updatePricesWithAI(), 600000);
            }

            bindEvents() {
                // Filter buttons
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const category = e.target.dataset.category;
                        this.filterProducts(category);
                    });
                });

                // Refresh prices button
                document.getElementById('refreshPrices').addEventListener('click', () => {
                    this.updatePricesWithAI();
                });

                // Close modal when clicking outside
                window.addEventListener('click', (e) => {
                    const cartModal = document.getElementById('cartModal');
                    const successModal = document.getElementById('successModal');
                    
                    if (e.target === cartModal) {
                        this.closeCart();
                    }
                    if (e.target === successModal) {
                        this.closeSuccess();
                    }
                });
            }

            async checkAIStatus() {
                const statusDiv = document.getElementById('aiStatus');
                
                try {
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    statusDiv.innerHTML = '<i class="fas fa-circle" style="color: #2E86C1;"></i> AI Analytics Connected - Live Price Updates';
                    statusDiv.className = 'ai-status';
                    console.log('‚úÖ AI service connected successfully');
                } catch (error) {
                    statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle" style="color: #C0392B;"></i> AI Service Unavailable';
                    statusDiv.className = 'ai-status error';
                    console.log('‚ùå AI service connection failed');
                }
            }

            async loadProducts() {
                try {
                    console.log('üì¶ Loading product catalog...');
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    this.loadFallbackData();
                } catch (error) {
                    console.error('Error loading products:', error);
                    this.loadFallbackData();
                }
            }

            loadFallbackData() {
                // Sample product data with expanded catalog
                this.products = [
                    { id: 1, name: "Urea (46-0-0)", price: 550, desc: "High nitrogen content fertilizer ideal for leafy growth and chlorophyll production. Perfect for cereals and vegetables.", category: "fertilizer", rating: 4.5, stock: 150, image: "üíä" },
                    { id: 2, name: "DAP (18-46-0)", price: 1200, desc: "Diammonium phosphate rich in phosphorus for strong root development and early plant establishment.", category: "fertilizer", rating: 4.7, stock: 89, image: "üß™" },
                    { id: 3, name: "MOP (0-0-60)", price: 800, desc: "Muriate of potash providing essential potassium for fruit quality, disease resistance, and overall plant health.", category: "fertilizer", rating: 4.3, stock: 200, image: "‚öóÔ∏è" },
                    { id: 4, name: "Hybrid Rice Seeds", price: 1500, desc: "High-yielding hybrid rice variety with excellent grain quality and disease resistance. Suitable for both seasons.", category: "seeds", rating: 4.8, stock: 45, image: "üåæ" },
                    { id: 5, name: "Organic Compost", price: 400, desc: "Premium organic compost made from cow dung and decomposed plant materials. Improves soil structure naturally.", category: "organic", rating: 4.6, stock: 300, image: "üå±" },
                    { id: 6, name: "NPK Complex (16-16-16)", price: 900, desc: "Balanced fertilizer providing equal amounts of nitrogen, phosphorus, and potassium for general crop nutrition.", category: "fertilizer", rating: 4.4, stock: 120, image: "‚öñÔ∏è" },
                    { id: 7, name: "Wheat Seeds (HD-2967)", price: 850, desc: "Dwarf variety wheat seeds with high protein content. Drought-tolerant and suitable for late sowing.", category: "seeds", rating: 4.6, stock: 60, image: "üåæ" },
                    { id: 8, name: "Knapsack Sprayer (16L)", price: 2500, desc: "High-pressure manual sprayer for pesticide and fertilizer application. Ergonomic design with adjustable nozzle.", category: "equipment", rating: 4.3, stock: 25, image: "üéí" }
                ];
                
                console.log(`üìã Loaded ${this.products.length} products successfully`);
                this.filterAndRender();
            }

            filterAndRender() {
                const filteredProducts = this.currentFilter === 'all' 
                    ? this.products 
                    : this.products.filter(p => p.category === this.currentFilter);
                
                this.renderProducts(filteredProducts);
                this.updateProductCount();
            }

            async updatePricesWithAI() {
                if (this.isUpdating) return;
                
                this.isUpdating = true;
                const refreshBtn = document.getElementById('refreshPrices');
                const statusDiv = document.getElementById('aiStatus');
                
                console.log('üîÑ Starting AI price update process...');
                
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating Prices...';
                statusDiv.className = 'ai-status loading';
                statusDiv.innerHTML = '<i class="fas fa-circle pulse"></i> AI Analyzing Market Trends...';

                document.querySelectorAll('.product-card').forEach(card => {
                    card.classList.add('loading');
                    const overlay = card.querySelector('.loading-overlay');
                    if (overlay) overlay.classList.add('show');
                });

                try {
                    await new Promise(resolve => setTimeout(resolve, 3000));
                    
                    // Simulate AI price updates
                    this.products = this.products.map(product => ({
                        ...product,
                        price: Math.round(product.price * (0.9 + Math.random() * 0.2)),
                        last_updated: new Date().toLocaleString()
                    }));
                    
                    this.filterAndRender();
                    statusDiv.className = 'ai-status';
                    statusDiv.innerHTML = '<i class="fas fa-circle" style="color: #2E86C1;"></i> Prices Updated by AI - Market Analysis Complete';
                    
                    console.log('‚úÖ AI price update completed successfully');
                    
                } catch (error) {
                    console.error('‚ùå Error updating prices:', error);
                    statusDiv.className = 'ai-status error';
                    statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle" style="color: #C0392B;"></i> Update Failed - Check Connection';
                } finally {
                    this.isUpdating = false;
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Update Prices with AI';
                    
                    document.querySelectorAll('.product-card').forEach(card => {
                        card.classList.remove('loading');
                        const overlay = card.querySelector('.loading-overlay');
                        if (overlay) overlay.classList.remove('show');
                    });
                }
            }

            filterProducts(category) {
                this.currentFilter = category;
                console.log(`üîç Filtering products by category: ${category}`);
                
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-category="${category}"]`).classList.add('active');
                
                this.filterAndRender();
            }

            updateProductCount() {
                const countDiv = document.getElementById('productCount');
                const categoryName = this.currentFilter === 'all' ? 'All Categories' : 
                    this.currentFilter.charAt(0).toUpperCase() + this.currentFilter.slice(1);
                
                const filteredCount = this.currentFilter === 'all' 
                    ? this.products.length 
                    : this.products.filter(p => p.category === this.currentFilter).length;
                
                countDiv.innerHTML = `Showing ${filteredCount} products in ${categoryName}`;
            }

            renderProducts(products = null) {
                const grid = document.getElementById('productsGrid');
                const productsToRender = products || (this.currentFilter === 'all' 
                    ? this.products 
                    : this.products.filter(p => p.category === this.currentFilter));
                
                if (!productsToRender.length) {
                    grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #7B7D7D;"><i class="fas fa-box-open" style="font-size: 3rem; margin-bottom: 20px;"></i><p>No products found</p></div>';
                    return;
                }

                grid.innerHTML = productsToRender.map(product => {
                    const cartItem = this.cart.find(item => item.id === product.id);
                    const quantity = cartItem ? cartItem.quantity : 0;
                    const isInCart = quantity > 0;
                    
                    return `
                        <div class="product-card" data-category="${product.category}">
                            <div class="loading-overlay">
                                <i class="fas fa-spinner fa-spin"></i> Updating...
                            </div>
                            
                            <div class="featured-badge">
                                <i class="fas fa-star"></i> Featured
                            </div>
                            
                            <div class="ai-powered-badge">
                                <i class="fas fa-robot"></i> AI Priced
                            </div>
                            
                            <div class="product-image">
                                ${product.image}
                            </div>
                            
                            <div class="product-content">
                                <h3 class="product-title">${product.name}</h3>
                                <p class="product-description">${product.desc}</p>
                                
                                <div class="product-info">
                                    <div class="rating">
                                        ${'‚òÖ'.repeat(Math.floor(product.rating))}${'‚òÜ'.repeat(5-Math.floor(product.rating))} ${product.rating}
                                    </div>
                                    <div class="stock ${product.stock < 50 ? 'low' : product.stock === 0 ? 'out' : ''}">
                                        ${product.stock > 0 ? `${product.stock} in stock` : 'Out of stock'}
                                    </div>
                                </div>
                                
                                <div class="quantity-controls">
                                    <button class="quantity-btn" onclick="marketplace.updateQuantity(${product.id}, -1)" ${quantity <= 0 ? 'disabled' : ''}>
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <div class="quantity-display">${quantity}</div>
                                    <button class="quantity-btn" onclick="marketplace.updateQuantity(${product.id}, 1)" ${product.stock === 0 ? 'disabled' : ''}>
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                
                                <div class="product-footer">
                                    <div class="price-container">
                                        <div class="price">‚Çπ${product.price.toLocaleString()}</div>
                                        ${product.last_updated ? `<div class="price-updated">AI Updated: ${product.last_updated}</div>` : ''}
                                    </div>
                                    <button class="buy-btn ${isInCart ? 'in-cart' : ''}" onclick="marketplace.${isInCart ? 'removeFromCart' : 'addToCart'}(${product.id})" ${product.stock === 0 ? 'disabled' : ''}>
                                        <i class="fas fa-${isInCart ? 'trash' : 'cart-plus'}"></i>
                                        ${product.stock === 0 ? 'Sold Out' : isInCart ? 'Remove' : 'Add to Cart'}
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            updateQuantity(productId, change) {
                const product = this.products.find(p => p.id === productId);
                if (!product) return;
                
                console.log(`üìä Updating quantity for ${product.name}: ${change > 0 ? '+' : ''}${change}`);
                
                const cartIndex = this.cart.findIndex(item => item.id === productId);
                
                if (cartIndex >= 0) {
                    this.cart[cartIndex].quantity += change;
                    if (this.cart[cartIndex].quantity <= 0) {
                        console.log(`üóëÔ∏è Removing ${product.name} from cart`);
                        this.cart.splice(cartIndex, 1);
                    }
                } else if (change > 0) {
                    console.log(`‚ûï Adding ${product.name} to cart`);
                    this.cart.push({
                        ...product,
                        quantity: change
                    });
                }
                
                this.updateCartUI();
                this.saveCart();
                this.filterAndRender();
            }

            addToCart(productId) {
                this.updateQuantity(productId, 1);
            }

            removeFromCart(productId) {
                const cartIndex = this.cart.findIndex(item => item.id === productId);
                if (cartIndex >= 0) {
                    const product = this.cart[cartIndex];
                    console.log(`üóëÔ∏è Removing ${product.name} completely from cart`);
                    this.cart.splice(cartIndex, 1);
                    this.updateCartUI();
                    this.saveCart();
                    this.filterAndRender();
                }
            }

            updateCartUI() {
                const cartCount = document.getElementById('cartCount');
                const totalItems = this.cart.reduce((sum, item) => sum + item.quantity, 0);
                cartCount.textContent = totalItems;
                cartCount.style.display = totalItems > 0 ? 'flex' : 'none';
                
                console.log(`üõí Cart updated: ${totalItems} items`);
            }

            openCart() {
                console.log('üõí Opening shopping cart...');
                const modal = document.getElementById('cartModal');
                const cartItems = document.getElementById('cartItems');
                const cartTotal = document.getElementById('cartTotal');
                
                if (this.cart.length === 0) {
                    cartItems.innerHTML = `
                        <div class="empty-cart">
                            <i class="fas fa-shopping-cart"></i>
                            <h3>Your cart is empty</h3>
                            <p>Add some professional farming supplies to get started!</p>
                        </div>
                    `;
                    cartTotal.innerHTML = '';
                } else {
                    console.log(`üìã Cart contains ${this.cart.length} different products`);
                    
                    cartItems.innerHTML = this.cart.map(item => `
                        <div class="cart-item">
                            <div class="cart-item-image">${item.image}</div>
                            <div class="cart-item-details">
                                <div class="cart-item-name">${item.name}</div>
                                <div class="cart-item-price">‚Çπ${item.price.toLocaleString()} each</div>
                                <div class="cart-item-controls">
                                    <button class="quantity-btn" onclick="marketplace.updateQuantity(${item.id}, -1)">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <div class="quantity-display">${item.quantity}</div>
                                    <button class="quantity-btn" onclick="marketplace.updateQuantity(${item.id}, 1)">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    <button class="buy-btn in-cart" onclick="marketplace.removeFromCart(${item.id})" style="margin-left: 15px; padding: 8px 12px;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 700; color: var(--primary-dark); font-size: 1.1rem;">
                                    ‚Çπ${(item.price * item.quantity).toLocaleString()}
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    const subtotal = this.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                    const shipping = subtotal > 2000 ? 0 : 100;
                    const tax = Math.round(subtotal * 0.05);
                    const total = subtotal + shipping + tax;
                    
                    console.log(`üí∞ Cart total: ‚Çπ${total.toLocaleString()}`);
                    
                    cartTotal.innerHTML = `
                        <div class="total-row">
                            <span>Subtotal:</span>
                            <span>‚Çπ${subtotal.toLocaleString()}</span>
                        </div>
                        <div class="total-row">
                            <span>Shipping:</span>
                            <span>${shipping === 0 ? 'Free' : '‚Çπ' + shipping}</span>
                        </div>
                        <div class="total-row">
                            <span>Tax (5%):</span>
                            <span>‚Çπ${tax.toLocaleString()}</span>
                        </div>
                        <div class="total-row grand-total">
                            <span>Total:</span>
                            <span>‚Çπ${total.toLocaleString()}</span>
                        </div>
                        <div class="payment-methods">
                            <span style="font-size: 0.9rem; margin-right: 10px;">Secure Payment:</span>
                            <div class="payment-icon">üí≥</div>
                            <div class="payment-icon">UPI</div>
                            <div class="payment-icon">NET</div>
                            <div class="payment-icon">CARD</div>
                        </div>
                        <button class="checkout-btn" onclick="marketplace.checkout()">
                            <i class="fas fa-lock"></i>
                            Pay ‚Çπ${total.toLocaleString()} with Razorpay
                        </button>
                    `;
                }
                
                modal.style.display = 'block';
            }

            closeCart() {
                console.log('‚ùå Closing shopping cart');
                document.getElementById('cartModal').style.display = 'none';
            }

            closeSuccess() {
                console.log('‚ùå Closing success modal');
                document.getElementById('successModal').style.display = 'none';
            }

            async checkout() {
                console.log('üè™ Starting checkout process...');
                
                const checkoutBtn = document.querySelector('.checkout-btn');
                checkoutBtn.disabled = true;
                checkoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Initializing Payment...';
                
                // Calculate total
                const subtotal = this.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const shipping = subtotal > 2000 ? 0 : 100;
                const tax = Math.round(subtotal * 0.05);
                const total = subtotal + shipping + tax;
                
                // Generate order ID
                const orderId = 'ORD-' + Date.now().toString(36).toUpperCase();
                
                // Simulate brief loading
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Clear cart first (will be restored if payment fails)
                const cartBackup = [...this.cart];
                this.cart = [];
                this.updateCartUI();
                this.saveCart();
                this.filterAndRender();
                this.closeCart();
                
                console.log('üîí Opening Razorpay payment gateway...');
                
                // Open Razorpay payment
                razorpayPayment(total, orderId);
                
                // Re-enable button (in case user cancels payment)
                checkoutBtn.disabled = false;
                checkoutBtn.innerHTML = '<i class="fas fa-lock"></i> Pay with Razorpay';
            }

            saveCart() {
                localStorage.setItem('farmingCart', JSON.stringify(this.cart));
                console.log('üíæ Cart saved to localStorage');
            }

            loadCart() {
                const savedCart = localStorage.getItem('farmingCart');
                if (savedCart) {
                    this.cart = JSON.parse(savedCart);
                    this.updateCartUI();
                    console.log('üìÇ Cart loaded from localStorage');
                }
            }
        }

        // Global instance
        let marketplace;

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            marketplace = new AIMarketplace();
            console.log('üåü Smart Farming Marketplace initialized with Razorpay payment gateway');
        });

        // Global functions for onclick handlers
        function openCart() {
            marketplace.openCart();
        }

        function closeCart() {
            marketplace.closeCart();
        }

        function closeSuccess() {
            marketplace.closeSuccess();
        }
    </script>
</body>
</html>
